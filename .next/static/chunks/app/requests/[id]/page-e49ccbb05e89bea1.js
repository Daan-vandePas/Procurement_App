(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[52],{9181:function(e,t,s){Promise.resolve().then(s.bind(s,9118))},9118:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return d}});var r=s(7437),a=s(2265),i=s(9376),l=s(7648);function o(e){let{items:t,onItemUpdate:s,onSubmitForApproval:i,processingItems:l,setProcessingItems:o,isSubmitting:n,uploadingFile:d,setUploadingFile:c}=e,[m,u]=(0,a.useState)({}),[p,x]=(0,a.useState)({}),[h,g]=(0,a.useState)({}),f=(e,t,s)=>{let r={...l[e]||{itemStatus:"pending"},[t]:s};if(o({...l,[e]:r}),m[e]){let t={...m};delete t[e],u(t)}},j=async(e,t)=>{c(e);try{let s=new FormData;s.append("file",t);let r=await fetch("/api/uploads",{method:"POST",body:s}),a=await r.json();if(!r.ok||!a.success)throw Error(a.error||"Upload failed");let i=a.url||a.blobUrl;if(!i)throw Error("Upload succeeded but no file URL returned");let n={...l[e]||{itemStatus:"pending"},costProof:i,costProofType:"pdf"===a.type?"pdf":"image"};o({...l,[e]:n}),x({...p,[e]:""})}catch(t){u({...m,[e]:t instanceof Error?t.message:"Upload failed"})}finally{c(null)}},v=async e=>{var t,r;let a=l[e];if(!a)return;let i="";if("rejected"===a.itemStatus?(null===(t=a.rejectionReason)||void 0===t?void 0:t.trim())||(i="Rejection reason is required"):"priced"!==a.itemStatus||(!a.actualCost||a.actualCost<=0?i="Actual cost must be greater than 0":(null===(r=a.costProof)||void 0===r?void 0:r.trim())||(i="Cost proof is required")),i){u({...m,[e]:i});return}try{await s({itemId:e,data:a}),u({...m,[e]:""}),g({...h,[e]:!1})}catch(t){u({...m,[e]:t instanceof Error?t.message:"Failed to save item"})}},b=e=>{switch(e){case"priced":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";default:return"bg-yellow-100 text-yellow-800"}};return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-lg font-medium text-blue-900",children:"Processing Progress"}),(0,r.jsxs)("p",{className:"text-sm text-blue-700",children:[t.filter(e=>{let t=l[e.id];return t&&"pending"!==t.itemStatus}).length," of ",t.length," items processed"]})]}),(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("div",{className:"w-32 bg-blue-200 rounded-full h-2 mr-3",children:(0,r.jsx)("div",{className:"bg-blue-600 h-2 rounded-full transition-all",style:{width:"".concat(t.filter(e=>{let t=l[e.id];return t&&"pending"!==t.itemStatus}).length/t.length*100,"%")}})}),(0,r.jsxs)("span",{className:"text-sm font-medium text-blue-900",children:[Math.round(t.filter(e=>{let t=l[e.id];return t&&"pending"!==t.itemStatus}).length/t.length*100),"%"]})]})]})}),(0,r.jsx)("div",{className:"space-y-4",children:t.map((e,t)=>{var s;let a=l[e.id]||{itemStatus:"pending"},i=m[e.id],n=!!a.actualCost&&a.actualCost>0,c=!!a.costProof&&"undefined"!==a.costProof&&a.costProof.toString().trim().length>0,u=d===e.id,g="pending"!==a.itemStatus;return h[e.id],(0,r.jsxs)("div",{className:"bg-white border rounded-lg p-6 ".concat(g?"border-green-200 bg-green-50":"border-gray-200"),children:[(0,r.jsxs)("div",{className:"flex justify-between items-start",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("h4",{className:"text-lg font-medium text-gray-900",children:["Item ",t+1,": ",e.itemName]}),(0,r.jsxs)("p",{className:"text-sm text-gray-600",children:["Quantity: ",e.quantity," | Estimated: €",e.estimatedCost]})]}),(0,r.jsx)("span",{className:"px-3 py-1 text-sm font-medium rounded-full ".concat(b(a.itemStatus)),children:a.itemStatus})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)("h5",{className:"text-sm font-medium text-gray-700",children:"Option 1: Add Pricing"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cost for total Quantity (€)"}),(0,r.jsx)("input",{type:"number",step:"0.01",min:"0",value:a.actualCost||"",onChange:t=>f(e.id,"actualCost",parseFloat(t.target.value)||void 0),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"0.00"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Supplier Name"}),(0,r.jsx)("input",{type:"text",value:a.supplierName||"",onChange:t=>f(e.id,"supplierName",t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"Enter supplier name"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Supplier Reference (Optional)"}),(0,r.jsx)("input",{type:"text",value:a.supplierReference||"",onChange:t=>f(e.id,"supplierReference",t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"Part number, SKU, or supplier reference"})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cost Proof"}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("input",{type:"file",accept:".pdf,.jpg,.jpeg,.png,.gif",onChange:t=>{var s;let r=null===(s=t.target.files)||void 0===s?void 0:s[0];r&&j(e.id,r)},className:"block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100",disabled:d===e.id}),d===e.id&&(0,r.jsx)("p",{className:"text-sm text-blue-600",children:"Uploading..."})]}),(0,r.jsx)("div",{children:(0,r.jsx)("input",{type:"url",value:p[e.id]||"",onChange:t=>{let s=t.target.value;x({...p,[e.id]:s});let r={...l[e.id]||{itemStatus:"pending"},costProof:s,costProofType:s?"link":void 0};o({...l,[e.id]:r})},className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"Or paste a link to cost proof"})}),a.costProof&&(0,r.jsxs)("p",{className:"text-sm text-green-600",children:["✓ Cost proof: ","link"===a.costProofType?"Link":"File"," uploaded"]})]})]}),(0,r.jsx)("button",{onClick:async()=>{try{f(e.id,"itemStatus","priced"),await new Promise(e=>setTimeout(e,50)),await v(e.id)}catch(e){console.error("Error saving priced item:",e)}},disabled:!(n&&c&&!u),className:"w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 disabled:opacity-50 disabled:cursor-not-allowed",children:u?"Uploading File...":"Save Pricing ".concat(n?c?"✓":"(Missing Proof)":"(Missing Cost)")})]}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)("h5",{className:"text-sm font-medium text-gray-700",children:"Option 2: Reject Item"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rejection Reason"}),(0,r.jsx)("textarea",{value:a.rejectionReason||"",onChange:t=>f(e.id,"rejectionReason",t.target.value),rows:4,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500",placeholder:"Explain why this item is being rejected..."})]}),(0,r.jsx)("button",{onClick:async()=>{f(e.id,"itemStatus","rejected"),setTimeout(()=>v(e.id),100)},disabled:!(null===(s=a.rejectionReason)||void 0===s?void 0:s.trim()),className:"w-full bg-red-600 text-white py-2 px-4 rounded-md hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed",children:"Reject Item"})]})]}),i&&(0,r.jsx)("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-md",children:(0,r.jsx)("p",{className:"text-sm text-red-700",children:i})})]},e.id)})}),null===d&&t.every(e=>{let t=l[e.id];return t&&"pending"!==t.itemStatus})&&(0,r.jsx)("div",{className:"bg-green-50 border border-green-200 rounded-lg p-6",children:(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-lg font-medium text-green-900",children:"Ready for Approval"}),(0,r.jsx)("p",{className:"text-sm text-green-700",children:"All items have been processed. You can now submit this request for approval."})]}),(0,r.jsx)("button",{onClick:i,disabled:n||null!==d,className:"bg-green-600 text-white py-3 px-6 rounded-md hover:bg-green-700 disabled:opacity-50 font-medium",children:n?"Validating & Submitting...":d?"Uploading files...":"Submit for Approval"})]})})]})}function n(e){let{items:t,onItemUpdate:s,onCompleteReview:i,approvalItems:l,setApprovalItems:o,isSubmitting:n}=e,[d,c]=(0,a.useState)({}),[m,u]=(0,a.useState)({}),[p,x]=(0,a.useState)({}),h=e=>{u({...m,[e]:!m[e]})},g=(e,t,s)=>{let r={...l[e]||{approvalStatus:"pending_approval"},[t]:s};if(o({...l,[e]:r}),d[e]){let t={...d};delete t[e],c(t)}},f=async(e,t)=>{if("reject"===t){x({...p,[e]:!0});return}try{let r;if(r="approve"===t?{approvalStatus:"approved",approvedBy:"CEO",approvedDate:new Date().toISOString()}:{approvalStatus:"pending_approval"},await s({itemId:e,data:r}),x({...p,[e]:!1}),d[e]){let t={...d};delete t[e],c(t)}}catch(t){c({...d,[e]:t instanceof Error?t.message:"Failed to update approval status"})}},j=async e=>{try{var t,r;let a=null===(r=l[e])||void 0===r?void 0:null===(t=r.ceoRejectionReason)||void 0===t?void 0:t.trim();if(!a){c({...d,[e]:"Rejection reason is required when rejecting an item"});return}let i={approvalStatus:"rejected",ceoRejectionReason:a,approvedBy:"CEO",approvedDate:new Date().toISOString()};if(await s({itemId:e,data:i}),x({...p,[e]:!1}),d[e]){let t={...d};delete t[e],c(t)}}catch(t){c({...d,[e]:t instanceof Error?t.message:"Failed to reject item"})}},v=e=>{switch(e){case"approved":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";default:return"bg-yellow-100 text-yellow-800"}},b=()=>t.every(e=>{var t;let s=(null===(t=l[e.id])||void 0===t?void 0:t.approvalStatus)||e.approvalStatus;return"approved"===s||"rejected"===s}),y=async()=>{if(!b()){c({...d,general:"Please review all items before completing the approval process"});return}try{await i()}catch(e){c({...d,general:e instanceof Error?e.message:"Failed to complete review"})}},N=(()=>{let e=t.filter(e=>{var t;return"approved"===((null===(t=l[e.id])||void 0===t?void 0:t.approvalStatus)||e.approvalStatus)}).length,s=t.filter(e=>{var t;return"rejected"===((null===(t=l[e.id])||void 0===t?void 0:t.approvalStatus)||e.approvalStatus)}).length,r=t.length-e-s;return{approved:e,rejected:s,pending:r}})();return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:(0,r.jsxs)("div",{className:"flex items-center",children:[(0,r.jsx)("svg",{className:"w-5 h-5 text-blue-400 mr-3",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,r.jsx)("div",{className:"flex-1",children:(0,r.jsxs)("p",{className:"text-sm font-medium text-blue-800",children:["Review Progress: ",N.approved," approved, ",N.rejected," rejected, ",N.pending," pending"]})})]})}),(0,r.jsx)("div",{className:"space-y-4",children:t.map((e,t)=>{var s,a,i,o,c;let u={approvalStatus:(null===(s=l[e.id])||void 0===s?void 0:s.approvalStatus)||e.approvalStatus||"pending_approval",ceoRejectionReason:(null===(a=l[e.id])||void 0===a?void 0:a.ceoRejectionReason)||e.ceoRejectionReason,approvedBy:(null===(i=l[e.id])||void 0===i?void 0:i.approvedBy)||e.approvedBy,approvedDate:(null===(o=l[e.id])||void 0===o?void 0:o.approvedDate)||e.approvedDate},b=m[e.id],y=d[e.id];return(0,r.jsxs)("div",{className:"border border-gray-200 rounded-lg bg-white",children:[(0,r.jsxs)("div",{className:"p-4 border-b border-gray-100",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-3",children:[(0,r.jsx)("button",{onClick:()=>h(e.id),className:"text-gray-400 hover:text-gray-600",children:(0,r.jsx)("svg",{className:"w-5 h-5 transform ".concat(b?"rotate-90":""),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})}),(0,r.jsxs)("h3",{className:"text-base font-medium text-gray-900",children:["Item ",t+1,": ",e.itemName]})]}),(0,r.jsx)("span",{className:"px-2 py-1 text-xs font-semibold rounded-full ".concat(v(u.approvalStatus)),children:"pending_approval"===u.approvalStatus?"Pending Review":"approved"===u.approvalStatus?"Approved":"Rejected"})]}),(0,r.jsxs)("div",{className:"mt-4 flex space-x-3",children:[(0,r.jsx)("button",{onClick:()=>f(e.id,"approve"),disabled:n,className:"px-4 py-2 text-sm font-medium rounded-md transition-colors ".concat("approved"===u.approvalStatus?"bg-green-600 text-white":"bg-green-100 text-green-700 hover:bg-green-200 disabled:opacity-50"),children:"approved"===u.approvalStatus?"✓ Approved":"Approve"}),(0,r.jsx)("button",{onClick:()=>f(e.id,"reject"),disabled:n,className:"px-4 py-2 text-sm font-medium rounded-md transition-colors ".concat("rejected"===u.approvalStatus?"bg-red-600 text-white":"bg-red-100 text-red-700 hover:bg-red-200 disabled:opacity-50"),children:"rejected"===u.approvalStatus?"✗ Rejected":"Reject"}),"pending_approval"!==u.approvalStatus&&(0,r.jsx)("button",{onClick:()=>f(e.id,"pending"),disabled:n,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors disabled:opacity-50",children:"Reset to Pending"})]}),("rejected"===u.approvalStatus||p[e.id])&&(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Rejection Reason *"}),(0,r.jsx)("textarea",{value:(null===(c=l[e.id])||void 0===c?void 0:c.ceoRejectionReason)||"",onChange:t=>g(e.id,"ceoRejectionReason",t.target.value),placeholder:"Please provide a reason for rejecting this item...",rows:3,className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"}),"rejected"!==u.approvalStatus&&(0,r.jsxs)("div",{className:"mt-2 flex space-x-3",children:[(0,r.jsx)("button",{onClick:()=>j(e.id),disabled:n,className:"px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md transition-colors disabled:opacity-50",children:"Submit Rejection"}),(0,r.jsx)("button",{onClick:()=>x({...p,[e.id]:!1}),disabled:n,className:"px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-md transition-colors disabled:opacity-50",children:"Cancel"})]})]}),y&&(0,r.jsx)("div",{className:"mt-2 text-sm text-red-600",children:y})]}),b&&(0,r.jsxs)("div",{className:"p-4 bg-gray-50",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h4",{className:"font-medium text-gray-900 mb-2",children:"Request Details"}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsxs)("p",{children:[(0,r.jsx)("span",{className:"text-gray-500",children:"Quantity:"})," ",e.quantity]}),(0,r.jsxs)("p",{children:[(0,r.jsx)("span",{className:"text-gray-500",children:"Priority:"})," ",e.priority]}),(0,r.jsxs)("p",{children:[(0,r.jsx)("span",{className:"text-gray-500",children:"Estimated Cost:"})," €",e.estimatedCost]}),(0,r.jsxs)("p",{children:[(0,r.jsx)("span",{className:"text-gray-500",children:"Needed By:"})," ",new Date(e.neededByDate).toLocaleDateString()]})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h4",{className:"font-medium text-gray-900 mb-2",children:"Purchaser Information"}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsxs)("p",{children:[(0,r.jsx)("span",{className:"text-gray-500",children:"Supplier:"})," ",e.supplierName||"Not specified"]}),(0,r.jsxs)("p",{children:[(0,r.jsx)("span",{className:"text-gray-500",children:"Reference:"})," ",e.supplierReference||"Not specified"]}),(0,r.jsxs)("p",{children:[(0,r.jsx)("span",{className:"text-gray-500",children:"Actual Cost:"})," ",e.actualCost?"€".concat(e.actualCost):"Not specified"]}),(0,r.jsxs)("p",{children:[(0,r.jsx)("span",{className:"text-gray-500",children:"Status:"}),(0,r.jsx)("span",{className:"ml-1 px-2 py-0.5 text-xs rounded-full ".concat("priced"===e.itemStatus?"bg-green-100 text-green-800":"rejected"===e.itemStatus?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"),children:e.itemStatus||"pending"})]})]})]})]}),(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("h4",{className:"font-medium text-gray-900 mb-1",children:"Justification"}),(0,r.jsx)("p",{className:"text-gray-700",children:e.justification})]}),e.rejectionReason&&(0,r.jsxs)("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-md",children:[(0,r.jsx)("h4",{className:"font-medium text-red-800 mb-1",children:"Purchaser Rejection Reason"}),(0,r.jsx)("p",{className:"text-red-700 text-sm",children:e.rejectionReason})]}),e.costProof&&(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("h4",{className:"font-medium text-gray-900 mb-1",children:"Cost Proof"}),"link"===e.costProofType?(0,r.jsx)("a",{href:e.costProof,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline text-sm break-all",children:e.costProof}):(0,r.jsx)("a",{href:e.costProof,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline text-sm",children:"View uploaded file"})]})]})]},e.id)})}),(0,r.jsxs)("div",{className:"flex justify-between items-center pt-6 border-t border-gray-200",children:[(0,r.jsx)("div",{children:d.general&&(0,r.jsx)("p",{className:"text-sm text-red-600",children:d.general})}),(0,r.jsx)("button",{onClick:y,disabled:!b()||n,className:"px-6 py-3 text-sm font-medium rounded-md transition-colors ".concat(b()&&!n?"bg-blue-600 text-white hover:bg-blue-700":"bg-gray-300 text-gray-500 cursor-not-allowed"),children:n?"Completing Review...":"Complete Review"})]})]})}function d(){let e=(0,i.useParams)(),t=(0,i.useRouter)(),s=e.id,[d,c]=(0,a.useState)(null),[m,u]=(0,a.useState)(null),[p,x]=(0,a.useState)(!0),[h,g]=(0,a.useState)(null),[f,j]=(0,a.useState)(!1),[v,b]=(0,a.useState)({}),[y,N]=(0,a.useState)(!1),[w,S]=(0,a.useState)(null),[R,P]=(0,a.useState)({});(0,a.useEffect)(()=>{let e=async()=>{try{let e=await fetch("/api/auth/me");if(!e.ok)throw Error("Authentication required");let t=await e.json();u(t);let r=await fetch("/api/requests/".concat(s));if(!r.ok){if(404===r.status)g("Request not found");else throw Error("Failed to fetch request");return}let a=await r.json();if(c(a),"purchaser"===t.role&&"requested"===a.status){let e={};a.items.forEach(t=>{e[t.id]={itemStatus:t.itemStatus||"pending",actualCost:t.actualCost,costProof:t.costProof,costProofType:t.costProofType,rejectionReason:t.rejectionReason,supplierName:t.supplierName,supplierReference:t.supplierReference}}),b(e)}if("ceo"===t.role&&"waiting_for_approval"===a.status){let e={};a.items.forEach(t=>{e[t.id]={approvalStatus:t.approvalStatus||"pending_approval",ceoRejectionReason:t.ceoRejectionReason,approvedBy:t.approvedBy,approvedDate:t.approvedDate}}),P(e)}}catch(e){g(e instanceof Error?e.message:"Failed to load data")}finally{x(!1)}};s&&e()},[s]);let C=async()=>{if(d&&confirm("Are you sure you want to delete this request? This action cannot be undone.")){j(!0);try{if(!(await fetch("/api/requests/".concat(d.id),{method:"DELETE"})).ok)throw Error("Failed to delete request");t.push("/requests")}catch(e){g(e instanceof Error?e.message:"Failed to delete request")}finally{j(!1)}}},k=async e=>{try{let t=await fetch("/api/requests/".concat(s,"/process"),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to update item")}let r=await t.json();c(r)}catch(e){throw e}},q=async()=>{try{console.log("\uD83D\uDD0D Pre-submit: Validating request state in database...");let e=await fetch("/api/requests/".concat(s));if(!e.ok)throw Error("Failed to fetch request state");let t=await e.json();console.log("\uD83D\uDCCA Pre-submit: Current request items:",t.items.map(e=>({id:e.id,itemName:e.itemName,itemStatus:e.itemStatus||"pending"})));let r=t.items.filter(e=>!e.itemStatus||"pending"===e.itemStatus);if(r.length>0){let e=r.map(e=>e.itemName).join(", ");return{isValid:!1,errorMessage:"".concat(r.length," item(s) still need processing: ").concat(e,". Please save all pricing information first.")}}return console.log("✅ Pre-submit: All items are processed in database"),{isValid:!0,errorMessage:null}}catch(e){return console.error("❌ Pre-submit validation error:",e),{isValid:!1,errorMessage:"Unable to verify request state. Please try again."}}},D=async()=>{N(!0);try{console.log("\uD83D\uDE80 Submit: Starting submission process...");let e=await q();if(!e.isValid){console.error("❌ Submit: Pre-validation failed:",e.errorMessage),g(e.errorMessage);return}console.log("✅ Submit: Pre-validation passed, proceeding with submission...");let t=await fetch("/api/requests/".concat(s,"/process"),{method:"POST"});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to submit for approval")}let r=await t.json();c(r.request),g(null)}catch(e){g(e instanceof Error?e.message:"Failed to submit for approval")}finally{N(!1)}},E=async e=>{try{let t=await fetch("/api/requests/".concat(s,"/approve"),{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let e=await t.json();throw Error(e.error||"Failed to update approval")}let r=await t.json();c(r);let a={};r.items.forEach(e=>{a[e.id]={approvalStatus:e.approvalStatus||"pending_approval",ceoRejectionReason:e.ceoRejectionReason,approvedBy:e.approvedBy,approvedDate:e.approvedDate}}),P(a)}catch(e){throw e}},_=async()=>{N(!0);try{let e=await fetch("/api/requests/".concat(s,"/approve"),{method:"POST"});if(!e.ok){let t=await e.json();throw Error(t.error||"Failed to complete review")}let t=await e.json();c(t.request),g(null)}catch(e){g(e instanceof Error?e.message:"Failed to complete review")}finally{N(!1)}},F=e=>{switch(e){case"urgent":return"bg-red-100 text-red-800";case"medium":return"bg-yellow-100 text-yellow-800";case"low":return"bg-green-100 text-green-800";default:return"bg-gray-100 text-gray-800"}},T=e=>{switch(e){case"priced":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";default:return"bg-yellow-100 text-yellow-800"}},B=(null==m?void 0:m.role)==="requester"&&(null==d?void 0:d.requesterName)===m.email&&(null==d?void 0:d.status)==="draft";(null==m?void 0:m.role)==="requester"&&(null==d?void 0:d.requesterName)===m.email&&(null==d||d.status);let A=(null==m?void 0:m.role)==="purchaser"&&(null==d?void 0:d.status)==="requested",I=(null==m?void 0:m.role)==="ceo"&&(null==d?void 0:d.status)==="waiting_for_approval";return p?(0,r.jsx)("div",{className:"space-y-6",children:(0,r.jsxs)("div",{className:"animate-pulse",children:[(0,r.jsx)("div",{className:"h-8 bg-gray-200 rounded w-1/3 mb-4"}),(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow p-6 space-y-4",children:[(0,r.jsx)("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),(0,r.jsx)("div",{className:"h-4 bg-gray-200 rounded w-1/2"}),(0,r.jsx)("div",{className:"h-32 bg-gray-200 rounded"})]})]})}):h?(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:"Request Details"}),(0,r.jsx)(l.default,{href:"/requests",className:"bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors",children:"Back to Requests"})]}),(0,r.jsx)("div",{className:"bg-red-50 border border-red-200 rounded-lg p-6",children:(0,r.jsxs)("div",{className:"flex",children:[(0,r.jsx)("svg",{className:"w-5 h-5 text-red-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,r.jsxs)("div",{className:"ml-3",children:[(0,r.jsx)("h3",{className:"text-sm font-medium text-red-800",children:"Error loading request"}),(0,r.jsx)("p",{className:"text-sm text-red-700 mt-1",children:h})]})]})})]}):d?(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:"Request Details"}),(0,r.jsxs)("p",{className:"text-gray-600",children:["Request ID: ",d.id]})]}),(0,r.jsxs)("div",{className:"flex space-x-3",children:[(0,r.jsx)(l.default,{href:"/requests",className:"bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors",children:"Back to Requests"}),B&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(l.default,{href:"/requests/".concat(d.id,"/edit"),className:"bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition-colors",children:"Edit Request"}),(0,r.jsx)("button",{onClick:C,disabled:f,className:"bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 transition-colors disabled:opacity-50",children:f?"Deleting...":"Delete Request"})]})]})]}),I&&(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow",children:[(0,r.jsxs)("div",{className:"p-6 border-b border-gray-200",children:[(0,r.jsx)("h3",{className:"text-lg font-medium text-gray-900",children:"Review Request Items"}),(0,r.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:"Review each item and approve or reject based on business requirements."})]}),(0,r.jsx)("div",{className:"p-6",children:(0,r.jsx)(n,{items:d.items,onItemUpdate:E,onCompleteReview:_,approvalItems:R,setApprovalItems:P,isSubmitting:y})})]}),!A&&!I&&(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow p-6",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 mb-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-sm font-medium text-gray-500",children:"Requester"}),(0,r.jsxs)("div",{className:"mt-1",children:[(0,r.jsx)("div",{className:"text-sm text-gray-900",children:d.requesterName.split("@")[0]}),(0,r.jsxs)("div",{className:"text-xs text-gray-500",children:["@",d.requesterName.split("@")[1]]})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-sm font-medium text-gray-500",children:"Status"}),(0,r.jsx)("span",{className:"mt-1 inline-flex px-2 py-1 text-xs font-semibold rounded-full ".concat((e=>{switch(e){case"requested":return"bg-blue-100 text-blue-800";case"waiting_for_approval":return"bg-yellow-100 text-yellow-800";case"approved":return"bg-green-100 text-green-800";case"rejected":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}})(d.status)),style:{whiteSpace:"pre-line",textAlign:"center"},children:"waiting_for_approval"===d.status?"Waiting for\nApproval":d.status.replace("_"," ").split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ")})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-sm font-medium text-gray-500",children:"Date Submitted"}),(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-900",children:new Date(d.requestDate).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-4",children:"Requested Items"}),(0,r.jsx)("div",{className:"space-y-6",children:d.items.map((e,t)=>(0,r.jsxs)("div",{className:"border border-gray-200 rounded-lg p-4",children:[(0,r.jsxs)("div",{className:"flex justify-between items-start mb-4",children:[(0,r.jsxs)("h4",{className:"text-base font-medium text-gray-900",children:["Item ",t+1,": ",e.itemName]}),(0,r.jsx)("span",{className:"px-2 py-1 text-xs font-semibold rounded-full ".concat(F(e.priority)),children:e.priority})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h5",{className:"text-sm font-medium text-gray-500",children:"Quantity"}),(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-900",children:e.quantity})]}),Number(e.estimatedCost)>0&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h5",{className:"text-sm font-medium text-gray-500",children:"Estimated Cost"}),(0,r.jsxs)("p",{className:"mt-1 text-sm text-gray-900",children:["€",e.estimatedCost]})]}),e.actualCost&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h5",{className:"text-sm font-medium text-gray-500",children:"Actual Cost"}),(0,r.jsxs)("p",{className:"mt-1 text-sm text-gray-900",children:["€",e.actualCost]})]}),e.itemStatus&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h5",{className:"text-sm font-medium text-gray-500",children:"Item Status"}),(0,r.jsx)("span",{className:"mt-1 inline-flex px-2 py-1 text-xs font-semibold rounded-full ".concat(T(e.itemStatus)),children:e.itemStatus})]}),e.supplierName&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h5",{className:"text-sm font-medium text-gray-500",children:"Supplier"}),(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-900",children:e.supplierName})]}),e.supplierReference&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h5",{className:"text-sm font-medium text-gray-500",children:"Supplier Reference"}),(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-900 break-all",children:e.supplierReference})]}),e.neededByDate&&(0,r.jsxs)("div",{children:[(0,r.jsx)("h5",{className:"text-sm font-medium text-gray-500",children:"Needed By"}),(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-900",children:new Date(e.neededByDate).toLocaleDateString()})]})]}),(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("h5",{className:"text-sm font-medium text-gray-500",children:"Justification"}),(0,r.jsx)("p",{className:"mt-1 text-sm text-gray-900",children:e.justification})]}),e.rejectionReason&&(0,r.jsxs)("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-md",children:[(0,r.jsx)("h5",{className:"text-sm font-medium text-red-800",children:"Rejection Reason"}),(0,r.jsx)("p",{className:"mt-1 text-sm text-red-700",children:e.rejectionReason})]}),e.costProof&&(0,r.jsxs)("div",{className:"mt-4",children:[(0,r.jsx)("h5",{className:"text-sm font-medium text-gray-500",children:"Cost Proof"}),"link"===e.costProofType?(0,r.jsx)("a",{href:e.costProof,target:"_blank",rel:"noopener noreferrer",className:"mt-1 text-sm text-blue-600 hover:underline break-all",children:e.costProof}):(0,r.jsx)("a",{href:e.costProof,target:"_blank",rel:"noopener noreferrer",className:"mt-1 text-sm text-blue-600 hover:underline",children:"View uploaded file"})]})]},e.id))})]})]}),A&&(0,r.jsxs)("div",{className:"bg-white rounded-lg shadow",children:[(0,r.jsxs)("div",{className:"p-6 border-b border-gray-200",children:[(0,r.jsx)("h3",{className:"text-lg font-medium text-gray-900",children:"Process Request Items"}),(0,r.jsx)("p",{className:"text-sm text-gray-600 mt-1",children:"Review each item and either add pricing information or reject the item."})]}),(0,r.jsx)("div",{className:"p-6",children:(0,r.jsx)(o,{items:d.items,onItemUpdate:k,onSubmitForApproval:D,processingItems:v,setProcessingItems:b,isSubmitting:y,uploadingFile:w,setUploadingFile:S})})]}),!B&&!A&&!I&&(0,r.jsx)("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:(0,r.jsxs)("div",{className:"flex",children:[(0,r.jsx)("svg",{className:"w-5 h-5 text-yellow-400",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})}),(0,r.jsx)("div",{className:"ml-3",children:(0,r.jsx)("p",{className:"text-sm text-yellow-800",children:(null==m?void 0:m.role)==="requester"&&"draft"!==d.status?"This request cannot be edited or deleted because it has already been submitted.":(null==m?void 0:m.role)==="ceo"&&"waiting_for_approval"===d.status?"This request is waiting for your approval.":"This request is being processed."})})]})})]}):null}},9376:function(e,t,s){"use strict";var r=s(5475);s.o(r,"useParams")&&s.d(t,{useParams:function(){return r.useParams}}),s.o(r,"usePathname")&&s.d(t,{usePathname:function(){return r.usePathname}}),s.o(r,"useRouter")&&s.d(t,{useRouter:function(){return r.useRouter}}),s.o(r,"useSearchParams")&&s.d(t,{useSearchParams:function(){return r.useSearchParams}})}},function(e){e.O(0,[648,971,117,744],function(){return e(e.s=9181)}),_N_E=e.O()}]);